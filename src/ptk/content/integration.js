/* Author: Denis Podgurskii */

(function () {
    if (window.ptk_integration || typeof browser === typeof undefined) return

    class ptk_integration {
        constructor() {
            this.origin = location.href
            this.eventName = "ptk_extension_event"
            this.addListeners()
        }

        addListeners() {
            this.windowListener = this.windowListener.bind(this)
            window.addEventListener("message", this.windowListener)
        }

        windowListener(e) {
            let message = e.data;
            if (message.channel == 'ptk_messages_channel') {
                if (this["msg_" + message.command]) {
                    this["msg_" + message.command](message.params).then(function (response) {
                        let detail = Object.assign({}, { event: message.command }, response)
                        try {
                            detail = cloneInto(detail, e.source.document) //FF fix
                        } catch (e) { }
                        document.dispatchEvent(new CustomEvent(this.eventName, { detail: detail }))
                    }.bind(this))
                }
            }
            if (message.channel == 'ptk_messages_channel_xss') {
                alert(message.command)
            }
        }

    }

    window.ptk_integration = new ptk_integration()

})()


