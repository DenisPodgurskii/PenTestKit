/* Author: Denis Podgurskii */


const dashboardText = `Reload the tab to activate tracking &nbsp;<i class="exclamation red circle icon" style="font-size: 1em; margin-bottom: 1px;"></i>`

function bindTable(id, params) {
    params.paging = false
    params.ordering = false
    params.info = false
    params.searching = params.searching ? params.searching : false
    params.sorting = false
    params.dom = 'frtip'
    //params.buttons = [ 'copyHtml5', 'excelHtml5', 'pdfHtml5', 'csvHtml5' ]


    let table
    if ($.fn.dataTable.isDataTable(id)) {
        table = $(id).DataTable()
        table.clear().rows.add(params.data).draw()
    } else {
        table = $(id).DataTable(params)
        // if (params.buttons) {
        //     table.buttons().container()
        //         .appendTo($('.col-sm-6:eq(0)', table.table().container()));
        // }
    }
    return table
}

jQuery(function () {


    setInterval(function () {
        browser.runtime.sendMessage({
            channel: "ptk_popup2background_app",
            type: "ping"
        })
    }, 1000);

    let version = browser.runtime.getManifest().version
    //Main menu
    $('#mainMenuWrapper').prepend(
        `<div class="ui small inverted borderless menu" style="height:12px">
            <img src="assets/images/hacker_w1.png" id="ptkicon" title="OWASP Penetration Testing Kit">
            <div class="ui container" id="mainMenu">
                <a class="item" href="index.html" data-history="index">Dashboard</a>
                <a class="item" href="session.html" data-history="session">Cookies</a>
                <a class="item" href="sca.html" data-history="sca">SCA</>
                <a class="item" href="proxy.html" data-history="proxy">Proxy</a>
                <a class="item" href="rbuilder.html" data-history="rbuilder">R-Builder</a>
                <a class="item" href="rattacker.html" data-history="rattacker">R-Attacker</a>
 
                <a class="item" href="recording.html" data-history="recording">Macro</a>

                <div class="ui top left pointing dropdown item" >Tools<i class="dropdown icon"></i>
                    <div class="menu" style="width: 100px;top: 25px;left: -17px;">
                    <a class="item" href="decoder.html" data-history="decoder">Decoder</a>
                    <a class="item" href="swagger-editor.html" data-history="swagger-editor">Swagger</a>
                    </div>
                </div>
    
                
                <!--div class="ui dropdown item " style="position: absolute;width: 30px;height: 30px;right: 34px;top: 3px;padding: 0px; ">
                    <i title="Profile" id="profile"></i>
                </div-->
                <div class="ui dropdown item notifications" style="position: absolute;width: 30px;height: 30px;right: 34px;top: 3px;padding: 0px; display:none">
                    <div><i title="Notifications" class=" red exclamation triangle big icon"></i></div>
                    <div class="menu">
                    <div class="ui error message" style="margin-top: 0px !important;">
                      <div class="header">Error</div>
                      <p>Cookie and storage access is disabled. Reinstall the extension or enable cookie/storage on the "Settings" page.</p>
                    </div>
                  </div>
                </div>
                <div class="ui dropdown item" style="position: absolute;width: 30px;height: 30px;right: 3px;top: 3px;padding: 0px;">
                    <div ><i title="More" class="question circle outline big icon"></i></div>
                    <div class="menu" style="margin-top: 0px !important; min-height: 90px;top: 34px;">
                        <div class="ui fitted divider" style="margin-top: 0px;"></div>
                        <a class="item" href="#" id="opensettings">Settings</a>
                        <div class="ui fitted divider"></div>
                        <a class="item" href="#" id="opennewwindow">Open in new window</a>
                        <a class="item" href="#" id="reloadextension">Reload PTK</a>
                        <div class="ui fitted divider"></div>
                        <a class="item" href="https://pentestkit.co.uk/howto.html" target="_blank">How to<i class="external square right floated icon"></i></a>
                        <a class="item" href="https://pentestkit.co.uk/release_notes.html" target="_blank">Release notes<i class="external square right floated icon"></i></a>
                        <div class="ui fitted divider"></div>
                        <a class="item" href="#" id="credits">Credits</a>
                        <a class="item" href="#" id="disclaimer">Disclaimer</a>
                        <a class="item" href="#" id="privacy">Privacy Policy</a>
                        <a class="item" href="#" id="contactus">Contact Us</a>
                        <div class="ui fitted divider"></div>
                        <a class="item disabled" href="#">Version: #${version}</a>
                    </div>
                </div>
            </div>
        </div>
        <div id='ptk_popup_dialog' class='ui fullscreen modal'>
        <i class="close icon" style="right: 2px;top: 2px;"></i>
        <iframe style="width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"></iframe>
        </div>
        `
    )

    $('#footer_menu').prepend(
        `
        <div class="ui mini message"
            style="height: 25px;padding-top: 4px;position: fixed; bottom: -11px; left:0px; z-index:1">
            <div class="header">Try PTK+ to get Pro version. More attacks and cloud storage - <a href="https://app.ptk-plus.io/" target="_blank">https://app.ptk-plus.io/</a></div>
        </div>

        <div class="ui mini message" style="height: 25px;position: fixed; bottom: 0px; right:0px; z-index:1; padding-top: 1px;padding-left: 4px; padding-right: 4px;">            
            <a href="https://www.youtube.com/channel/UCbEcTounPkV1aitE1egXfqw/" target="_blank"><i
            class="youtube big icon" title="PTK on youtube" style="margin-top: -18px;"></i></a>
            <a href="https://pentestkit.co.uk" target="_blank"><i class="globe big icon" title="PTK website"
                    style="margin-top: -18px;"></i></a>
            <a href="https://twitter.com/pentestkit" target="_blank"><i class="twitter big icon" title="PTK on Twitter"
                    style="margin-top: -18px;"></i></a>
            <a href="https://owasp.org/www-project-penetration-testing-kit/" target="_blank"><img
                    src="assets/images/owasp.png" title="PTK on OWASP" style="width: 24px; padding:1px"></a>
        </div>
  
        <!--div class="ui mini message"
            style="height: 25px;padding-top: 4px;position: fixed; bottom: -11px; left:130px; z-index:1">
            <a href="mailto:info@pentestkit.co.uk">info@pentestkit.co.uk</a>
        </div>
        <div class="ui mini message"
            style="height: 25px;padding-top: 4px;position: fixed; bottom: -11px; left:130px; z-index:1">
            <a href="mailto:info@pentestkit.co.uk">info@pentestkit.co.uk</a>
        </div>
        <div class="ui mini orange message"
            style="height: 25px;padding-top: 4px;position: fixed; bottom: -11px; left:269px; z-index:1">
            <i class="exclamation circle icon"></i><a target="_blank"
                href="https://www.true-positives.com/ptk-community">Please help us
                improve the PTK</a>
        </div>

        <div class="ui mini message"
            style="height: 25px;padding-top: 4px;position: fixed; bottom: -11px; right:100px; z-index:1">
            <div class="ui form">
                <div class=" fields">
                    <div class="eight wide field" style="margin-top: -1px;"><b style="font-size: .78571429em;">Trusted
                            by</b> &nbsp;</div>
                    <div class="four wide field ui icon right corner" style="padding-left: 10px;padding-right:0px">
                        <a href="https://www.invicti.com/" target="_blank"><img class="logo"
                                src="assets/images/invicti-logo-black.svg"
                                title="The Largest Dynamic Application Security Solutions Provider In The World"
                                style="width: 60px; margin-top: -4px;float: right;"></a>
                    </div>
                    <div class="one wide field" style="padding-left: 3px;"> <sup><i class="trademark icon"></i></sup>
                    </div>
                </div>
            </div>

        </div>

        <div class=""
            style="height: 25px;position: fixed; bottom: 3px; right:0px; z-index:1; padding-left: 4px;">
            <a href="https://www.paypal.com/donate/?hosted_button_id=RNE87MVGX576E" target="_blank"><img
            src="assets/images/paypal.png" title="Donation" style="width: 140px;"></a>
        </div-->

        `
    )

    $('#attack_details_dialog_wrapper').prepend(

        `

        <div id="attack_details" class="ui fullscreen modal coupled" style="display: none; height: 83%">
            <i class="close icon"></i>
            <div class="ui header" id="attack_name"></div>
            <div class="content" style="min-height: 400px; overflow: scroll;height: 90%; padding: 2px 7px 2px 2px;scrollbar-width: none;">
                <form class="ui tiny form controls" id="attack_details_form">
                    <input type="hidden" id="attack_target" name="request_url">
                    <div class="fields" style="min-height: 65%;height: 65%; margin-bottom: 4px;">
                        <div class="eight wide field" style="padding-right: 1px;overflow:scroll;scrollbar-width: none;">

                            <textarea readonly id="raw_request" class="ui small input" rows="25" placeholder="Request"
                                style="height: 100%; padding-top: 35px;scrollbar-width: none;"></textarea>
                            
                            <div class="ui large label"
                                style="position: absolute; top: 0px; left: -3px;
                                z-index: 1;
                                height: 34px;
                                padding-top: 10px;
                                margin-top: -2px;
                                width: inherit;">
                                Request
                                <div class="ui mini icon secondary button send_rbuilder" style="position: absolute;top: 0px;right: -8px;z-index: 1;">
                                    <i class=" wrench large icon" title="Send to R-Builder"></i>
                                </div>
                            </div>
                     
                        </div>
                        <div class="eight wide field response_view" style="padding-right: 1px;">

                                <div class="ui large label"
                                    style="position: fixed;z-index: 1; height: 34px; padding-top: 10px;margin-top: -2px;min-width: -webkit-fill-available;">
                                    Response
                                    <div class="ui small secondary button showHtml"
                                    style="position: absolute;top: 0px;right: -2px;z-index: 1;">
                                    HTML
                                    </div>
                                </div>

                                <textarea readonly id="raw_response" name="response_body" class="ui small input" rows="25"
                                    placeholder="Response" style="height: 100%; padding-top: 35px;scrollbar-width: none;"
                                    autofocus></textarea>
   
                        </div>
                    </div>

                    <div class="ui segment" style="padding: 0px;margin-right: -4px;margin-top: 0px;min-height: 35%;">
                        <div class="ui top attached tabular menu small metadata" style="background-color: #e8e8e8;">
                            <a class="item active" data-tab="first">Description</a>
                            <a class="item" data-tab="second">Recommendation</a>
                            <a class="item" data-tab="third">Links</a>
                        </div>
                        <div class="ui bottom attached tab segment small active" data-tab="first" style="min-height: 75%;">
                            <div id="attack_description"></div>
                        </div>
                        <div class="ui bottom attached tab segment small" data-tab="second" style="min-height: 75%;">
                            <div id="attack_recommendation"></div>
                        </div>
                        <div class="ui bottom attached tab segment small" data-tab="third" style="min-height: 75%;">
                            <div class="ui middle aligned divided list" id="attack_links">
                            </div>
                        </div>
                    </div>


                </form>
            </div>
        </div>
        <div id="dialogResponseHtml" class="ui fullscreen modal coupled" style="display: none;height: 83%">
            <i class="close icon"></i>
            <div class="header">HTML response</div>
            
            <div class="content" id="dialogResponseHtmlContent" style="min-height: 400px;height: 90%;padding:0px">
                <object id="dialogResponseHtmlContentObj" data="" style="overflow:hidden;height:100%;width:100%; min-height: 400px;" height="100%"></object>
            </div>
        </div>
        `
    )


    if (window.opener) {
        $('#opennewwindow').hide()
    }

    $('#mainMenu a.item').each(function (i, obj) {
        if (window.location.pathname.indexOf($(obj).attr('href')) > 0)
            $(obj).addClass('active').siblings().removeClass('active')
    });

    $('#mainMenu a.item').on('click', function () {
        let route = $(this).attr('data-history')
        if (route) {
            browser.runtime.sendMessage({
                channel: "ptk_popup2background_app",
                type: "history",
                route: route,
                hash: ""
            })
        }
    })

    //Submenu all pages
    $('.ui.menu a.item').on('click', function () {
        $(this).addClass('active').siblings().removeClass('active')
        let forItem = $(this).attr('forItem')
        $('.ui.menu a.item').each(function (i, obj) {
            let f = $(obj).attr('forItem')
            if (f != forItem) $('#' + f).hide()
        })
        $('#' + forItem).fadeIn("slow")
    })

    //Settings page
    $('#opensettings').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'settings.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //Privacy page
    $('#privacy').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'privacy.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //Contact page
    $('#contactus').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'contact.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //Disclaimer page
    $('#disclaimer').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'disclaimer.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //Credits page
    $('#credits').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'credits.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //Credits page
    $('#profile').on('click', function () {
        $('#ptk_popup_dialog iframe').attr('src', 'profile.html')
        $('#ptk_popup_dialog').modal('show')
    })

    //New window
    $('#opennewwindow').on('click', function () {
        browser.windows.create({ url: window.location.href, type: "popup", width: 900, height: 650 })
        window.close();
    });

    //Reload
    $('#reloadextension').on('click', function () {
        browser.runtime.sendMessage({
            channel: "ptk_popup2background_app",
            type: "reloadptk"
        }).catch(e => e)
    });

    //Semantic UI 
    $('.ui.dropdown').dropdown({ on: 'click' })
    $('.ui.checkbox').checkbox()
    $('.dropdown.allowAdditions')
        .dropdown({
            allowAdditions: true
        })

})